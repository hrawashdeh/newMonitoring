<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!--
        Elasticsearch-Compatible Structured Logging Configuration
        Authentication & Authorization Service

        Profiles:
        - dev/default: Human-readable console logging (Kubernetes)
        - prod/production: JSON structured logging for Elasticsearch/ELK

        Features:
        - MDC fields: requestId, correlationId, username, userId, endpoint, ipAddress, authMethod
        - Profile-based log formats
        - Elasticsearch-compatible JSON in production

        Author: Hassan Rawashdeh
        Date: 2025-12-31
    -->

    <!-- Load Spring properties -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="auth-service"/>
    <springProperty scope="context" name="LOG_LEVEL" source="logging.level.root" defaultValue="INFO"/>
    <property name="LOG_PATH" value="${LOG_PATH:-./logs}"/>

    <!-- ============================================ -->
    <!-- DEV/DEFAULT PROFILE (Human-readable console) -->
    <!-- ============================================ -->
    <springProfile name="dev,default">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - [requestId=%X{requestId}] [username=%X{username}] [endpoint=%X{endpoint}] - %msg%n</pattern>
            </encoder>
        </appender>

        <logger name="com.tiqmo.monitoring.auth" level="DEBUG"/>
        <logger name="org.springframework.web" level="DEBUG"/>
        <logger name="org.springframework.security" level="DEBUG"/>
        <logger name="io.jsonwebtoken" level="DEBUG"/>
        <logger name="org.hibernate" level="WARN"/>
        <logger name="com.zaxxer.hikari" level="INFO"/>

        <root level="${LOG_LEVEL}">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- ============================================ -->
    <!-- PRODUCTION PROFILE (Elasticsearch JSON logging) -->
    <!-- ============================================ -->
    <springProfile name="prod,production">
        <!-- Console JSON Appender for Kubernetes/Elasticsearch -->
        <appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <!-- Include MDC fields -->
                <includeMdcKeyName>requestId</includeMdcKeyName>
                <includeMdcKeyName>correlationId</includeMdcKeyName>
                <includeMdcKeyName>username</includeMdcKeyName>
                <includeMdcKeyName>userId</includeMdcKeyName>
                <includeMdcKeyName>endpoint</includeMdcKeyName>
                <includeMdcKeyName>method</includeMdcKeyName>
                <includeMdcKeyName>statusCode</includeMdcKeyName>
                <includeMdcKeyName>duration</includeMdcKeyName>
                <includeMdcKeyName>ipAddress</includeMdcKeyName>
                <includeMdcKeyName>userAgent</includeMdcKeyName>
                <includeMdcKeyName>authMethod</includeMdcKeyName>
                <includeMdcKeyName>tokenType</includeMdcKeyName>
                <includeMdcKeyName>loginSuccess</includeMdcKeyName>
                <includeMdcKeyName>failureReason</includeMdcKeyName>

                <!-- Custom fields -->
                <customFields>{"service_name":"${APP_NAME}","environment":"production","service_type":"authentication"}</customFields>

                <!-- Shorten logger names -->
                <shortenedLoggerNameLength>36</shortenedLoggerNameLength>

                <!-- Stack trace configuration -->
                <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                    <maxDepthPerThrowable>30</maxDepthPerThrowable>
                    <maxLength>2048</maxLength>
                    <shortenedClassNameLength>20</shortenedClassNameLength>
                    <exclude>sun\.reflect\..*</exclude>
                    <exclude>net\.sf\.cglib\..*</exclude>
                    <exclude>org\.springframework\.aop\..*</exclude>
                    <rootCauseFirst>true</rootCauseFirst>
                </throwableConverter>
            </encoder>
        </appender>

        <!-- Package-specific loggers for production -->
        <logger name="com.tiqmo.monitoring.auth" level="INFO"/>
        <logger name="org.springframework.web" level="WARN"/>
        <logger name="org.springframework.security" level="INFO"/>
        <logger name="io.jsonwebtoken" level="INFO"/>
        <logger name="org.hibernate" level="WARN"/>
        <logger name="com.zaxxer.hikari" level="INFO"/>

        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
        </root>
    </springProfile>

    <!-- ============================================ -->
    <!-- Common Logger Configurations (All Profiles) -->
    <!-- ============================================ -->

    <!-- Reduce noise from Spring framework -->
    <logger name="org.springframework.boot.autoconfigure" level="WARN"/>
    <logger name="org.springframework.boot.actuator" level="INFO"/>
    <logger name="org.springframework.data.jpa" level="WARN"/>

    <!-- Authentication & Authorization -->
    <logger name="com.tiqmo.monitoring.auth.service" level="INFO"/>
    <logger name="com.tiqmo.monitoring.auth.api" level="INFO"/>
    <logger name="com.tiqmo.monitoring.auth.security" level="INFO"/>

    <!-- JWT token processing -->
    <logger name="io.jsonwebtoken" level="INFO"/>

</configuration>
