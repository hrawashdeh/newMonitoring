<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!--
        Elasticsearch-Compatible Structured Logging Configuration
        API Gateway Service

        Profiles:
        - dev/default: Human-readable console logging (Kubernetes)
        - prod/production: JSON structured logging for Elasticsearch/ELK

        Features:
        - MDC fields: requestId, correlationId, routeId, targetUri, etc.
        - Profile-based log formats
        - Elasticsearch-compatible JSON in production

        Author: Hassan Rawashdeh
        Date: 2025-12-31
    -->

    <!-- Load Spring properties -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="gateway-service"/>
    <springProperty scope="context" name="LOG_LEVEL" source="logging.level.root" defaultValue="INFO"/>
    <property name="LOG_PATH" value="${LOG_PATH:-./logs}"/>

    <!-- ============================================ -->
    <!-- DEV/DEFAULT PROFILE (Human-readable console) -->
    <!-- ============================================ -->
    <springProfile name="dev,default">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - [correlationId=%X{correlationId}] [requestId=%X{requestId}] [routeId=%X{routeId}] [requestPath=%X{requestPath}] - %msg%n</pattern>
            </encoder>
        </appender>

        <logger name="com.tiqmo.monitoring.gateway" level="DEBUG"/>
        <logger name="org.springframework.cloud.gateway" level="DEBUG"/>
        <logger name="org.springframework.web.reactive" level="DEBUG"/>
        <logger name="reactor.netty" level="INFO"/>
        <logger name="io.github.resilience4j" level="DEBUG"/>

        <root level="${LOG_LEVEL}">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- ============================================ -->
    <!-- PRODUCTION PROFILE (Elasticsearch JSON logging) -->
    <!-- ============================================ -->
    <springProfile name="prod,production">
        <!-- Console JSON Appender with nested fields for Elasticsearch -->
        <appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <!-- Standard fields -->
                    <timestamp>
                        <fieldName>@timestamp</fieldName>
                        <pattern>yyyy-MM-dd'T'HH:mm:ss.SSSZ</pattern>
                    </timestamp>
                    <logLevel>
                        <fieldName>log.level</fieldName>
                    </logLevel>
                    <message>
                        <fieldName>message</fieldName>
                    </message>
                    <loggerName>
                        <fieldName>logger</fieldName>
                        <shortenedLoggerNameLength>36</shortenedLoggerNameLength>
                    </loggerName>
                    <threadName>
                        <fieldName>thread</fieldName>
                    </threadName>

                    <!-- Service info -->
                    <pattern>
                        <pattern>
                            {
                                "service.name": "${APP_NAME}",
                                "service.version": "1.0.0",
                                "service.type": "api-gateway"
                            }
                        </pattern>
                    </pattern>

                    <!-- Nested trace fields -->
                    <pattern>
                        <pattern>
                            {
                                "trace": {
                                    "id": "%mdc{trace.id}",
                                    "span_id": "%mdc{span.id}",
                                    "correlation_id": "%mdc{correlationId}",
                                    "request_id": "%mdc{requestId}",
                                    "process_id": "%mdc{processId}"
                                }
                            }
                        </pattern>
                    </pattern>

                    <!-- Nested context fields -->
                    <pattern>
                        <pattern>
                            {
                                "context": {
                                    "service_id": "%mdc{serviceId}",
                                    "context_id": "%mdc{contextId}",
                                    "class": "%mdc{class}",
                                    "method": "%mdc{method}",
                                    "phase": "%mdc{phase}"
                                }
                            }
                        </pattern>
                    </pattern>

                    <!-- Nested integration fields -->
                    <pattern>
                        <pattern>
                            {
                                "integration": {
                                    "type": "%mdc{integrationType}",
                                    "direction": "%mdc{integrationDirection}",
                                    "target": "%mdc{requestPath}",
                                    "method": "%mdc{httpMethod}",
                                    "status_code": "%mdc{statusCode}",
                                    "duration_ms": "%mdc{duration}"
                                }
                            }
                        </pattern>
                    </pattern>

                    <!-- Nested user fields -->
                    <pattern>
                        <pattern>
                            {
                                "user": {
                                    "id": "%mdc{userId}",
                                    "username": "%mdc{username}",
                                    "ip": "%mdc{clientIp}",
                                    "user_agent": "%mdc{userAgent}"
                                }
                            }
                        </pattern>
                    </pattern>

                    <!-- Nested domain fields (gateway-specific) -->
                    <pattern>
                        <pattern>
                            {
                                "domain": {
                                    "route_id": "%mdc{routeId}",
                                    "target_uri": "%mdc{targetUri}",
                                    "circuit_breaker_state": "%mdc{circuitBreakerState}",
                                    "retry_count": "%mdc{retryCount}"
                                }
                            }
                        </pattern>
                    </pattern>

                    <!-- Stack trace -->
                    <stackTrace>
                        <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                            <maxDepthPerThrowable>30</maxDepthPerThrowable>
                            <maxLength>2048</maxLength>
                            <shortenedClassNameLength>20</shortenedClassNameLength>
                            <exclude>sun\.reflect\..*</exclude>
                            <exclude>net\.sf\.cglib\..*</exclude>
                            <exclude>org\.springframework\.aop\..*</exclude>
                            <rootCauseFirst>true</rootCauseFirst>
                        </throwableConverter>
                    </stackTrace>
                </providers>
            </encoder>
        </appender>

        <!-- Package-specific loggers for production -->
        <logger name="com.tiqmo.monitoring.gateway" level="INFO"/>
        <logger name="org.springframework.cloud.gateway" level="INFO"/>
        <logger name="org.springframework.web.reactive" level="WARN"/>
        <logger name="reactor.netty" level="INFO"/>
        <logger name="io.github.resilience4j" level="INFO"/>
        <logger name="reactor.core" level="WARN"/>

        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
        </root>
    </springProfile>

    <!-- ============================================ -->
    <!-- Common Logger Configurations (All Profiles) -->
    <!-- ============================================ -->

    <!-- Reduce noise from Spring framework -->
    <logger name="org.springframework.boot.autoconfigure" level="WARN"/>
    <logger name="org.springframework.boot.actuator" level="INFO"/>

    <!-- Gateway-specific loggers -->
    <logger name="com.tiqmo.monitoring.gateway.filter" level="INFO"/>

</configuration>
